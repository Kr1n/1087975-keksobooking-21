(()=>{"use strict";window.util={getRandomInt:(e,t)=>Math.floor(e+Math.random()*Math.floor(t-e)),removeAllChildNodes:e=>{for(;e.firstChild;)e.removeChild(e.firstChild)},debounce:e=>{let t=null;return(...o)=>{t&&window.clearTimeout(t),t=window.setTimeout((()=>e(...o)),500)}}},window.data={offers:[]},(()=>{window.backend={load:(o,n)=>{n||(n=t);let r=new XMLHttpRequest;e(r,o,n),r.open("GET","https://21.javascript.pages.academy/keksobooking/data"),r.send()},save:(o,n,r)=>{r||(r=t);let d=new XMLHttpRequest;e(d,n,r),d.open("POST","https://21.javascript.pages.academy/keksobooking"),d.send(o)}};const e=(e,t,o)=>{e.responseType="json",e.addEventListener("load",(function(){200===e.status?t(e.response):o("Статус ответа: "+e.status+" "+e.statusText)})),e.addEventListener("error",(function(){o("Произошла ошибка соединения")})),e.addEventListener("timeout",(function(){o("Запрос не успел выполниться за "+e.timeout+"мс")})),e.timeout=5e3},t=e=>{let t=document.createElement("div");t.style="z-index: 100; margin: 0 auto; text-align: center; background-color: red;",t.style.position="absolute",t.style.left=0,t.style.right=0,t.style.fontSize="30px",t.classList.add("error-message"),t.textContent=e,setTimeout((()=>{document.querySelector(".error-message").remove()}),5e3),document.body.insertAdjacentElement("afterbegin",t)}})(),(()=>{window.filters={apply:function(e){return i=c(e),i=s(i),i=a(i),i=u(i),i=l(i),i}};const e=document.querySelector("#housing-type"),t=document.querySelector("#housing-price"),o=document.querySelector("#housing-rooms"),n=document.querySelector("#housing-guests"),r=document.querySelector("#housing-features"),d=r.querySelectorAll("input");let i;const c=t=>t.filter((t=>"any"===e.value||e.value===t.offer.type)),s=e=>e.filter((e=>{switch(t.value){case"low":return Number(e.offer.price)<=1e4;case"middle":return Number(e.offer.price)>1e4&&Number(e.offer.price)<=5e4;case"high":return Number(e.offer.price)>5e4;default:return!0}})),a=e=>e.filter((e=>"any"===o.value||o.value===e.offer.rooms.toString())),u=e=>e.filter((e=>{switch(n.value){case"any":return!0;case"0":return Number(e.offer.guests)>2||0===Number(e.offer.guests);default:return Number(n.value)===e.offer.guests}})),l=e=>{let t=[];return d.forEach((e=>{e.checked&&t.push(e.defaultValue)})),t.length?e.filter((e=>(t.every((t=>-1!==e.offer.features.indexOf(t))),!0))):e},m=()=>{window.pin.closeCard(),window.map.renderPins()};e.addEventListener("change",window.util.debounce(m)),t.addEventListener("change",window.util.debounce(m)),o.addEventListener("change",window.util.debounce(m)),n.addEventListener("change",window.util.debounce(m)),r.addEventListener("change",window.util.debounce(m))})(),(()=>{window.card={render:function(n){let r=e.querySelectorAll(".map__card"),d=document.createElement("div");r.forEach((e=>e.remove())),d.appendChild(function(e){let n,r=t.cloneNode(!0).content,d=o[e.offer.type],i=document.createDocumentFragment();e.offer.photos.forEach((e=>{n=r.querySelector(".popup__photos img").cloneNode(!0),n.src=e,i.appendChild(n)}));let c,s=document.createDocumentFragment();e.offer.features.forEach((e=>{c=document.createElement("li"),c.classList.add("popup__feature"),c.classList.add("popup__feature--"+e),s.appendChild(c)})),r.querySelector(".popup__title").textContent=e.offer.title,r.querySelector(".popup__text--address").textContent=e.offer.address,r.querySelector(".popup__text--price").textContent=e.offer.price+"₽/ночь",r.querySelector(".popup__type").textContent=d,r.querySelector(".popup__text--capacity").textContent=e.offer.rooms+" комнаты для "+e.offer.guests+" гостей",r.querySelector(".popup__text--time").textContent="Заезд после "+e.offer.checkin+", выезд до "+e.offer.checkout,r.querySelector(".popup__description").textContent=e.offer.description,r.querySelector("img").src=e.author.avatar;let a=r.querySelector(".popup__photos");window.util.removeAllChildNodes(a),a.appendChild(i);let u=r.querySelector(".popup__features");return window.util.removeAllChildNodes(u),u.appendChild(s),r}(n)),e.querySelector(".map__filters-container").insertAdjacentHTML("beforebegin",d.innerHTML),e.querySelector(".popup__close").addEventListener("click",(e=>{window.pin.closeCard(e.target)})),e.querySelector(".popup__close").addEventListener("keydown",(e=>{"Enter"===e.key&&window.pin.closeCard()})),document.addEventListener("keydown",window.pin.onCardEscPress)}};const e=document.querySelector(".map"),t=document.querySelector("#card"),o={flat:"Квартира",bungalow:"Бунгало",house:"Дом",palace:"Дворец"}})(),(()=>{const e=document.querySelector(".map");function t(){let t=e.querySelector(".popup");t&&t.classList.add("hidden"),document.removeEventListener("keydown",o)}function o(e){"Escape"===e.key&&(e.preventDefault(),t())}window.pin={onCardEscPress:o,onMainEnterPress:function(e){"Enter"===e.key&&window.map.setActiveState()},onMainMousePress:function(e){"object"==typeof e&&0===e.button&&window.map.setActiveState()},closeCard:t,width:50,height:70}})(),(()=>{const e=document.querySelector("#pin"),t=document.querySelector(".map"),o=document.querySelectorAll(".ad-form fieldset"),n=document.querySelectorAll(".map__filters > *"),r=document.querySelector(".ad-form"),d=document.querySelector(".map__pin--main");t.classList.remove("map--faded"),window.map={renderPins:s,setActiveState:function(){o.forEach((e=>e.disabled=!1)),r.classList.remove("ad-form--disabled"),t.classList.remove("map--faded"),window.backend.load(a),d.removeEventListener("mousedown",window.pin.onMainMousePress),d.removeEventListener("keydown",window.pin.onMainEnterPress)},setNonActiveState:function(){o.forEach((e=>e.disabled=!0)),n.forEach((e=>e.disabled=!0)),r.classList.add("ad-form--disabled"),t.classList.add("map--faded"),d.addEventListener("mousedown",window.pin.onMainMousePress),d.addEventListener("keydown",window.pin.onMainEnterPress)},clearPins:c};let i=t=>{let o=e.cloneNode(!0).content;return o.querySelector(".map__pin").style="left: "+(t.location.x-window.pin.width/2)+"px; top: "+(t.location.y-window.pin.height)+"px;",o.querySelector("img").src=t.author.avatar,o.querySelector("img").alt=t.offer.title,o};function c(){t.querySelectorAll(".map__pins button").forEach((e=>{e.classList.contains("map__pin--main")||e.remove()}))}function s(){c();let e=t.querySelector(".map__pins"),o=document.createDocumentFragment(),n=window.filters.apply(window.data.offers);const r=5<n.length?5:n.length;for(let e=0;e<r;e++)o.appendChild(i(n[e]));e.appendChild(o);let d=t.querySelectorAll(".map__pin");for(let e=0;e<r;e++)d[e+1].addEventListener("click",(()=>window.card.render(n[e])))}let a=e=>{window.data={offers:e},window.data.offers.length&&n.forEach((e=>e.disabled=!1)),s()}})(),window.page={resetPage:()=>{window.form.reset(),window.map.clearPins(),window.map.setNonActiveState(),window.mainPin.moveMainPin(570,375)}},function(){const e=["gif","jpg","jpeg","png"],t=document.querySelector(".map__pin--main"),o=document.querySelector(".ad-form__reset"),n=document.querySelector(".ad-form"),r=document.querySelector("#address"),d=(document.querySelectorAll(".ad-form fieldset"),document.querySelector("#room_number")),i=document.querySelector("#capacity"),c=document.querySelector("#type"),s=document.querySelector("#price"),a=document.querySelector("#timein"),u=document.querySelector("#timeout"),l=document.querySelector(".ad-form__field input[type=file]"),m=document.querySelector(".ad-form-header__preview img"),p=document.querySelector(".ad-form__upload input[type=file]"),f=document.querySelector(".ad-form__photo");let w;window.form={setAddressValue:function(e,t){r.value=Math.floor(e)+", "+Math.floor(t)},reset:function(e){for(e&&e.preventDefault(),window.form.setAddressValue(t.offsetLeft+window.mainPin.width/2,t.offsetTop+window.mainPin.height),document.querySelector("#title").value="",document.querySelector("#type").selectedIndex=1,document.querySelector("#price").value="",document.querySelector("#room_number").selectedIndex=0,document.querySelector("#capacity").selectedIndex=2,document.querySelector("#description").value="",document.querySelector("#timein").selectedIndex=0,document.querySelector("#timeout").selectedIndex=0,document.querySelector("#avatar").value="",document.querySelector("#images").value="",document.querySelector(".ad-form-header__preview img").src="img/muffin-grey.svg";f.firstChild;)f.removeChild(f.firstChild);document.querySelectorAll(".features input").forEach((e=>e.checked=0))}};const y=(t,o)=>{let n=t.name.toLowerCase();if(e.some((e=>n.endsWith(e)))){let e=new FileReader;e.addEventListener("load",(()=>{o.src=e.result})),e.readAsDataURL(t)}};l.addEventListener("change",(()=>{y(l.files[0],m)})),p.addEventListener("change",(()=>{let e=document.createElement("img");e.setAttribute("width","70"),e.setAttribute("height","70"),e.setAttribute("alt","Предпросмотр картинки пользователя"),f.appendChild(e),y(p.files[0],f.querySelector("img"))}));const v=()=>{const e=i[i.selectedIndex].value,t=d[d.selectedIndex].value;"0"===e&&"100"===t?i.setCustomValidity(""):e!==t?i.setCustomValidity("Количество гостей и комнат не совпадает"):i.setCustomValidity("")};d.addEventListener("input",v),i.addEventListener("input",v),c.addEventListener("input",(e=>{let t=0,o=0;switch(e.target.options.selectedIndex){case 0:t=0,o=0;break;case 1:t=1e3,o=1e3;break;case 2:t=5e3,o=5e3;break;case 3:t=1e4,o=1e4}s.setAttribute("placeholder",o),s.setAttribute("min",t)})),a.addEventListener("input",(e=>{u.options.selectedIndex=e.target.options.selectedIndex})),u.addEventListener("input",(e=>{a.options.selectedIndex=e.target.options.selectedIndex}));const h=e=>{"Escape"===e.key&&(e.preventDefault(),q(),document.removeEventListener("keydown",h),document.removeEventListener("click",S))},S=e=>{q(),document.removeEventListener("keydown",h),document.removeEventListener("click",S)},q=()=>w.remove(),g=e=>{const t=document.querySelector("#error");document.querySelector("main").appendChild(t.cloneNode(!0).content),w=document.querySelector(".error"),document.addEventListener("keydown",h),document.addEventListener("click",S)},E=e=>{const t=document.querySelector("#success");document.querySelector("main").appendChild(t.cloneNode(!0).content),w=document.querySelector(".success"),document.addEventListener("keydown",h),document.addEventListener("click",S),window.page.resetPage()};n.addEventListener("submit",(e=>{e.preventDefault(),window.backend.save(new FormData(n),E,g)})),o.addEventListener("click",window.page.resetPage)}(),(()=>{const e=document.querySelector(".map"),t=document.querySelector(".map__pin--main");let o={},n=!1;window.mainPin={width:62,height:84,moveMainPin:(e,o)=>{t.style.top=(Number(o)?o:t.offsetTop)+"px",t.style.left=(Number(e)?e:t.offsetLeft)+"px",window.form.setAddressValue(t.offsetLeft+31,t.offsetTop+84)}},t.addEventListener("mousedown",(e=>{e.preventDefault(),n=!1,o={x:e.clientX,y:e.clientY},document.addEventListener("mousemove",d),document.addEventListener("mouseup",r)}));const r=e=>{if(e.preventDefault(),document.removeEventListener("mousemove",d),document.removeEventListener("mouseup",r),n){const e=o=>{o.preventDefault(),t.removeEventListener("click",e)};t.addEventListener("click",e)}},d=r=>{n=!0;let d=o.x-r.clientX,i=o.y-r.clientY;o={x:r.clientX,y:r.clientY};let c=t.offsetLeft-d;c<-31?c=-31:c>e.offsetWidth-31&&(c=e.offsetWidth-31);let s=t.offsetTop-i;s<46?s=46:s>546&&(s=546),t.style.top=s+"px",t.style.left=c+"px",window.form.setAddressValue(t.offsetLeft+31,t.offsetTop+84)}})(),document.querySelector(".map__pin--main"),window.map.setNonActiveState(),window.form.setAddressValue(window.mainPin.offsetLeft+window.mainPin.width/2,window.mainPin.offsetTop+window.mainPin.height)})();